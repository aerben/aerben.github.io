<!DOCTYPE html>
<html lang=En>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="IntroductionThere are numerous ways to package a Java application into a Docker image and then deploy it to AWS. The usual approach would be to set up an ECS cluster to deploy containers. Actually, I">
<meta name="keywords" content="aws,java,docker">
<meta property="og:type" content="article">
<meta property="og:title" content="Deploy a Java app as Docker container on AWS with Maven (Part 1)">
<meta property="og:url" content="https://www.aerben.me/2017/docker-maven-1/index.html">
<meta property="og:site_name" content="aerben.me">
<meta property="og:description" content="IntroductionThere are numerous ways to package a Java application into a Docker image and then deploy it to AWS. The usual approach would be to set up an ECS cluster to deploy containers. Actually, I">
<meta property="og:locale" content="English">
<meta property="og:updated_time" content="2018-11-12T09:32:12.258Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deploy a Java app as Docker container on AWS with Maven (Part 1)">
<meta name="twitter:description" content="IntroductionThere are numerous ways to package a Java application into a Docker image and then deploy it to AWS. The usual approach would be to set up an ECS cluster to deploy containers. Actually, I">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.png">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
          
        
    
    <!-- title -->
    <title>Deploy a Java app as Docker container on AWS with Maven (Part 1)</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
</head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/imprint/">Imprint/Impressum</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/docker-maven-2/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2017/thanks-github/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://www.aerben.me/2017/docker-maven-1/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://www.aerben.me/2017/docker-maven-1/&text=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.aerben.me/2017/docker-maven-1/&is_video=false&description=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Deploy a Java app as Docker container on AWS with Maven (Part 1)&body=Check out this article: https://www.aerben.me/2017/docker-maven-1/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://www.aerben.me/2017/docker-maven-1/&name=Deploy a Java app as Docker container on AWS with Maven (Part 1)&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Preparations"><span class="toc-number">2.</span> <span class="toc-text">Preparations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-an-ECR-repository"><span class="toc-number">3.</span> <span class="toc-text">Creating an ECR repository</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-dockerfile-maven"><span class="toc-number">4.</span> <span class="toc-text">Using dockerfile-maven</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authenticate-Docker-against-ECR"><span class="toc-number">5.</span> <span class="toc-text">Authenticate Docker against ECR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">6.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Deploy a Java app as Docker container on AWS with Maven (Part 1)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Alexander Erben</span>
      </span>
      
    <div class="postdate">
        <time datetime="2017-11-19T13:01:46.000Z" itemprop="datePublished">2017-11-19</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/aws/">aws</a>, <a class="tag-link" href="/tags/docker/">docker</a>, <a class="tag-link" href="/tags/java/">java</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>There are numerous ways to package a Java application into a Docker image and then deploy it to AWS. The usual approach would be to set up an <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener">ECS</a> cluster to deploy containers. Actually, I will write a post over benefits and pitfalls of using ECS later on. For now, we will do the bare-bones approach and use a simple EC2 instance set up via Cloudformation to deploy a docker container.</p>
<p>To follow along, you can have a look at the source code of the resulting setup I created on <a href="https://github.com/aerben/aerben.github.io-samples/tree/master/docker-maven" target="_blank" rel="noopener"><i class="fa fa-github"></i> GitHub</a>. However, if you want to try things out yourself, you can start with your own maven based application or use my sample application that I mention below.</p>
<h2 id="Preparations"><a href="#Preparations" class="headerlink" title="Preparations"></a>Preparations</h2><p>In a <a href="../using-spark-java">recent post</a>, I created a minimal Spark Java application built with Maven which we can take as baseline. You can get the source code from my <a href="https://github.com/aerben/aerben.github.io-samples/tree/master/spark-sample-service" target="_blank" rel="noopener"><i class="fa fa-github"></i> GitHub</a> repository.</p>
<p>After cloning the repo, you can build and run the app as follows<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mvn package &amp;&amp; java -jar target/spark-sample-service-jar-with-dependencies.jar</span><br><span class="line">[Thread-0] INFO org.eclipse.jetty.server.ServerConnector - Started ServerConnector@1b7eb264&#123;HTTP/1.1,[http/1.1]&#125;&#123;0.0.0.0:8080&#125;</span><br><span class="line">[Thread-0] INFO org.eclipse.jetty.server.Server - Started @326ms</span><br></pre></td></tr></table></figure></p>
<p>The app now listens to port 8080 and sends you a neat little message when you point your browser to it. </p>
<p>We now have an application we want to deploy, the next question is how we want to build a docker image of it. It’s super easy to just write a simple Dockerfile using the Java 8-Alpine base image, adding the jar and executing it in the entrypoint. </p>
<p>This time however, we want to fully integrate the creation of a Docker image into the Maven build lifecycle. To that end, we use Spotify’s <a href="https://github.com/spotify/dockerfile-maven" target="_blank" rel="noopener">dockerfile-maven-plugin</a>. It not only streamlines our build automation pipeline by reducing the number of steps necessary to perform a build and deployment. It also speeds up the Docker image build by caching Maven dependencies. At least that’s what Spotify promises.  </p>
<h2 id="Creating-an-ECR-repository"><a href="#Creating-an-ECR-repository" class="headerlink" title="Creating an ECR repository"></a>Creating an ECR repository</h2><p>First things first: As we want to deploy our application into AWS, we want to set up a Container Registry in our AWS account. Amazon Web Services’ offering to create a registry is called Elastic Container Registry (ECR).<br>I assume you have already set up the <a href="https://aws.amazon.com/cli‎" target="_blank" rel="noopener">AWS CLI</a> on your machine, and have attached the <a href="http://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_IAM_policies.html" target="_blank" rel="noopener">necessary permissions</a> to create an ECR-Repository and push images to it. We can now create a new ECR registry as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ aws ecr create-repository --repository-name spark-sample-service</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;repository&quot;: &#123;</span><br><span class="line">        &quot;registryId&quot;: &quot;[[REGISTRY_ID]]&quot;,</span><br><span class="line">        &quot;repositoryName&quot;: &quot;spark-sample-service&quot;,</span><br><span class="line">        &quot;repositoryArn&quot;: &quot;arn:aws:ecr:eu-central-1:[[ACCOUNT_ID]]:repository/spark-sample-service&quot;,</span><br><span class="line">        &quot;createdAt&quot;: 1511103918.0,</span><br><span class="line">        &quot;repositoryUri&quot;: &quot;[[ACCOUNT_ID]].dkr.ecr.eu-central-1.amazonaws.com/spark-sample-service&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Take note of the repository ARN and URI for later reference so you don’t have to look it up in the AWS Console later on. That is all regarding ECR for now.</p>
<h2 id="Using-dockerfile-maven"><a href="#Using-dockerfile-maven" class="headerlink" title="Using dockerfile-maven"></a>Using dockerfile-maven</h2><p>Parts of the following description is based off the samples provided by Spotify for the dockerfile-maven-plugin, especially the <a href="https://github.com/spotify/dockerfile-maven/tree/master/plugin/src/it/advanced" target="_blank" rel="noopener">advanced</a> example.<br>The first thing we have to make sure is that all project dependencies are copied into a separate folder in the project’s target directory. This is a notable difference from the <a href="https://github.com/aerben/aerben.github.io-samples/tree/master/spark-sample-service" target="_blank" rel="noopener">sample application</a> that I have provided above, which bundles all dependencies into one fat jar that includes everything to be executable. Spotify recommends the former approach as it allows to cache individual dependencies in the docker image. </p>
<p>Remove the maven-assembly-plugin and maven-jar-plugin entries from the pom of the sample application and add the following plugins to the build-section of the pom.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>me.aerben.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>initialize<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">overWriteReleases</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteReleases</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">includeScope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">includeScope</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>f</span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">`</span><br></pre></td></tr></table></figure>
<p>The maven-jar-plugin configuration makes sure that the source code of your application is bundled with a fitting manifest file that specifies the main class and classpath entries necessary to find the dependencies relative to the jar file location. The dependency plugin then makes sure that all dependencies are copied into the <code>lib</code> folder in the project’s target.</p>
<p>We will now configure the dockerfile-plugin itself. First, add a properties-segment to your pom and specify the aws account id:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">awsAccountId</span>&gt;</span>Enter account id here<span class="tag">&lt;/<span class="name">awsAccountId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>You can either enter your account ID here, or pass it in later by appending <code>-DawsAccountId=[[YOUR_ACCOUNT_ID_HERE]]</code> to every maven command.<br>Then, add the following plugin definition to your pom:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>default<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;awsAccountId&#125;.dkr.ecr.eu-central-1.amazonaws.com/$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Remember that you have to put the repository URI of your ECR registry in the configuration. The rest is straightforward: the plugin will hook into Maven’s build lifecycle and build the image when the application is packaged, then push it when it is deployed.</p>
<p>The last missing thing is a Dockerfile that specifies how our docker image is to be built.<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jre-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span> ["/usr/bin/java", "-jar", "/tmp/app/app.jar"]</span><br><span class="line"></span><br><span class="line">ADD target/lib           /tmp/app/lib</span><br><span class="line">ARG JAR_FILE</span><br><span class="line">ADD target/$&#123;JAR_FILE&#125; /tmp/app/app.jar</span><br></pre></td></tr></table></figure></p>
<p>As you can see the jar <em>and</em> the library dependencies are added to the image, allowing the plugin to cache individual dependencies and not always copy a fat jar on each build,</p>
<p>We can now try our setup by running <code>mvn deploy</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mvn deploy</span><br><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-deploy-plugin:2.7:deploy (default-deploy) on project spark-sample-service: Deployment failed: repository element was not specified in the POM inside distributionManagement element or in -DaltDeploymentRepository=id::layout::url parameter -&gt; [Help 1]</span><br></pre></td></tr></table></figure>
<p>Something’s missing: When running <code>mvn deploy</code>, by default Maven wants to push the built artifact into an artifact manager like Nexus. To that end, the repository must be configured in the distribution management of the pom. If you do not have an artifact manager at hand, you can disable this behaviour by adding the following build plugin configuration:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Authenticate-Docker-against-ECR"><a href="#Authenticate-Docker-against-ECR" class="headerlink" title="Authenticate Docker against ECR"></a>Authenticate Docker against ECR</h2><p>We can now try again:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mvn package</span><br><span class="line">[ERROR] Failed to execute goal com.spotify:dockerfile-maven-plugin:1.3.6:push (default) on project spark-sample-service: Could not push image: no basic auth credentials -&gt; [Help 1]</span><br></pre></td></tr></table></figure></p>
<p>This starts to get annoying! But the mistake is on our side: In order to push images to ECR, we have to authenticate against it with basic auth credentials. Luckily, this is a very easy task with the help of the AWS CLI.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws ecr get-login --no-include-email</span><br><span class="line">docker login -u AWS -p PASSWORD -e none https://[[ACCOUNT_ID]].dkr.ecr.eu-central-1.amazonaws.com</span><br></pre></td></tr></table></figure></p>
<p>The cli returns for us a ready-to use command line call to authenticate our local Docker installation with ECR. </p>
<p>After having logged in, we could assume that the plugin picks up the credentials and uses it to authenticate against ECR. On Linux, this will work, but sadly, on macOS, Docker by default uses the macOS keychain to store the credentials (you can see it in <code>~/.docker/config.json</code>), and this workflow is <a href="https://github.com/spotify/docker-maven-plugin/issues/321" target="_blank" rel="noopener">not working with dockerfile-maven</a>.</p>
<p>To work around this issue, we can store the credentials in <code>.m2/settings.xml</code> and tell the plugin to use these credentials to authenticate against ECR. This is an inconvenient approach as it makes automation much harder: the credentials are only temporary, so we have to write a script that puts the credentials in <code>settings.xml</code> everytime they expire.<br>Anyway: If you a are a Mac user like me, put the folling server entry in <code>.m2/settings.xml</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>[[ACCOUNT_ID]].dkr.ecr.eu-central-1.amazonaws.com<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>AWS<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>[YOUR_PASSWORD]<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Please don’t forget to fill in your ECR repository ID and temporary password.<br>Then go ahead and add the <code>useMavenSettingsForAuth</code> configuration property to the dockerfile-maven-plugin declaration:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    (...)</span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;awsAccountId&#125;.dkr.ecr.eu-central-1.amazonaws.com/$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        (...)</span><br><span class="line">        <span class="comment">&lt;!-- the following one --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">useMavenSettingsForAuth</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useMavenSettingsForAuth</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>This tells the plugin to take the credentials from <code>settings.xml</code>.<br>Now, finally, we can push the image:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ mvn deploy</span><br><span class="line">(...)</span><br><span class="line">[INFO] --- dockerfile-maven-plugin:1.3.6:push (default) @ spark-sample-service ---</span><br><span class="line">[INFO] The push refers to a repository [[[ACCOUNT_ID]].dkr.ecr.eu-central-1.amazonaws.com/spark-sample-service]</span><br><span class="line">[INFO] Image 11f5b463d7c9: Preparing</span><br><span class="line">[INFO] Image 6c374bfe7f7e: Preparing</span><br><span class="line">[INFO] Image 6abaa286b4af: Preparing</span><br><span class="line">[INFO] Image 7f22a835d8ba: Preparing</span><br><span class="line">[INFO] Image 2aebd096e0e2: Preparing</span><br><span class="line">[INFO] Image 2aebd096e0e2: Layer already exists</span><br><span class="line">[INFO] Image 7f22a835d8ba: Layer already exists</span><br><span class="line">[INFO] Image 6abaa286b4af: Layer already exists</span><br><span class="line">[INFO] Image 6c374bfe7f7e: Layer already exists</span><br><span class="line">[INFO] Image 11f5b463d7c9: Pushing</span><br><span class="line">[INFO] Image 11f5b463d7c9: Pushed</span><br><span class="line">[INFO] 1.0: digest: sha256:b4823b325f0ef9c016bcba35024486a1bcd80f1b2d69315904c03521fee63aa8 size: 1366</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 11.147 s</span><br><span class="line">[INFO] Finished at: 2017-11-19T16:54:46+01:00</span><br><span class="line">[INFO] Final Memory: 29M/458M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></p>
<p>And to test it, we can simply start a container from the newly pushed image:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -p 8080:8080 [[ACCOUNT_ID]].dkr.ecr.eu-central-1.amazonaws.com/spark-sample-service:1.0 &amp;</span><br><span class="line">$ curl localhost:8080</span><br><span class="line">It&apos;s me!</span><br></pre></td></tr></table></figure></p>
<p>Whew, that was a lot of work - and the EC2 part has not even begun. Let’s take a break, grab a coffee and come back later in another post.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li>Spotify’s dockerfile-maven-plugin: <a href="https://github.com/spotify/docker-maven-plugin" target="_blank" rel="noopener">https://github.com/spotify/docker-maven-plugin</a></li>
<li>ECR reference documentation: <a href="https://aws.amazon.com/documentation/ecr/" target="_blank" rel="noopener">https://aws.amazon.com/documentation/ecr/</a></li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Archives</a></li>
        
          <li><a href="/imprint/">Imprint/Impressum</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol>
          <ol>
            <li class="toc-item toc-level-2"><a class="toc-link" href="#"> Start</a></li>
          </ol>
          <li>
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Preparations"><span class="toc-number">2.</span> <span class="toc-text">Preparations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-an-ECR-repository"><span class="toc-number">3.</span> <span class="toc-text">Creating an ECR repository</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-dockerfile-maven"><span class="toc-number">4.</span> <span class="toc-text">Using dockerfile-maven</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authenticate-Docker-against-ECR"><span class="toc-number">5.</span> <span class="toc-text">Authenticate Docker against ECR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">6.</span> <span class="toc-text">References</span></a></li></ol>
          </li>
      </ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://www.aerben.me/2017/docker-maven-1/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://www.aerben.me/2017/docker-maven-1/&text=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.aerben.me/2017/docker-maven-1/&is_video=false&description=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Deploy a Java app as Docker container on AWS with Maven (Part 1)&body=Check out this article: https://www.aerben.me/2017/docker-maven-1/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://www.aerben.me/2017/docker-maven-1/&title=Deploy a Java app as Docker container on AWS with Maven (Part 1)"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://www.aerben.me/2017/docker-maven-1/&name=Deploy a Java app as Docker container on AWS with Maven (Part 1)&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 Alexander Erben
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/imprint/">Imprint/Impressum</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

<!-- Disqus Comments -->


